import cheerio from "cheerio";
const fs = require("fs");

export const generateSvg = (siteSource: string, text: string, svgFileName) => {
  var pixels = [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5f, 0x00, 0x00, 0x00, 0x07,
    0x00, 0x07, 0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14, 0x24, 0x2a, 0x7f, 0x2a,
    0x12, 0x23, 0x13, 0x08, 0x64, 0x62, 0x36, 0x49, 0x55, 0x22, 0x50, 0x00,
    0x05, 0x03, 0x00, 0x00, 0x00, 0x1c, 0x22, 0x41, 0x00, 0x00, 0x41, 0x22,
    0x1c, 0x00, 0x08, 0x2a, 0x1c, 0x2a, 0x08, 0x08, 0x08, 0x3e, 0x08, 0x08,
    0x00, 0x50, 0x30, 0x00, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x60,
    0x60, 0x00, 0x00, 0x20, 0x10, 0x08, 0x04, 0x02, 0x3e, 0x51, 0x49, 0x45,
    0x3e, 0x00, 0x42, 0x7f, 0x40, 0x00, 0x42, 0x61, 0x51, 0x49, 0x46, 0x21,
    0x41, 0x45, 0x4b, 0x31, 0x18, 0x14, 0x12, 0x7f, 0x10, 0x27, 0x45, 0x45,
    0x45, 0x39, 0x3c, 0x4a, 0x49, 0x49, 0x30, 0x01, 0x71, 0x09, 0x05, 0x03,
    0x36, 0x49, 0x49, 0x49, 0x36, 0x06, 0x49, 0x49, 0x29, 0x1e, 0x00, 0x36,
    0x36, 0x00, 0x00, 0x00, 0x56, 0x36, 0x00, 0x00, 0x00, 0x08, 0x14, 0x22,
    0x41, 0x14, 0x14, 0x14, 0x14, 0x14, 0x41, 0x22, 0x14, 0x08, 0x00, 0x02,
    0x01, 0x51, 0x09, 0x06, 0x32, 0x49, 0x79, 0x41, 0x3e, 0x7e, 0x11, 0x11,
    0x11, 0x7e, 0x7f, 0x49, 0x49, 0x49, 0x36, 0x3e, 0x41, 0x41, 0x41, 0x22,
    0x7f, 0x41, 0x41, 0x22, 0x1c, 0x7f, 0x49, 0x49, 0x49, 0x41, 0x7f, 0x09,
    0x09, 0x01, 0x01, 0x3e, 0x41, 0x41, 0x51, 0x32, 0x7f, 0x08, 0x08, 0x08,
    0x7f, 0x00, 0x41, 0x7f, 0x41, 0x00, 0x20, 0x40, 0x41, 0x3f, 0x01, 0x7f,
    0x08, 0x14, 0x22, 0x41, 0x7f, 0x40, 0x40, 0x40, 0x40, 0x7f, 0x02, 0x04,
    0x02, 0x7f, 0x7f, 0x04, 0x08, 0x10, 0x7f, 0x3e, 0x41, 0x41, 0x41, 0x3e,
    0x7f, 0x09, 0x09, 0x09, 0x06, 0x3e, 0x41, 0x51, 0x21, 0x5e, 0x7f, 0x09,
    0x19, 0x29, 0x46, 0x46, 0x49, 0x49, 0x49, 0x31, 0x01, 0x01, 0x7f, 0x01,
    0x01, 0x3f, 0x40, 0x40, 0x40, 0x3f, 0x1f, 0x20, 0x40, 0x20, 0x1f, 0x7f,
    0x20, 0x18, 0x20, 0x7f, 0x63, 0x14, 0x08, 0x14, 0x63, 0x03, 0x04, 0x78,
    0x04, 0x03, 0x61, 0x51, 0x49, 0x45, 0x43, 0x00, 0x00, 0x7f, 0x41, 0x41,
    0x02, 0x04, 0x08, 0x10, 0x20, 0x41, 0x41, 0x7f, 0x00, 0x00, 0x04, 0x02,
    0x01, 0x02, 0x04, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x01, 0x02, 0x04,
    0x00, 0x20, 0x54, 0x54, 0x54, 0x78, 0x7f, 0x48, 0x44, 0x44, 0x38, 0x38,
    0x44, 0x44, 0x44, 0x20, 0x38, 0x44, 0x44, 0x48, 0x7f, 0x38, 0x54, 0x54,
    0x54, 0x18, 0x08, 0x7e, 0x09, 0x01, 0x02, 0x08, 0x14, 0x54, 0x54, 0x3c,
    0x7f, 0x08, 0x04, 0x04, 0x78, 0x00, 0x44, 0x7d, 0x40, 0x00, 0x20, 0x40,
    0x44, 0x3d, 0x00, 0x00, 0x7f, 0x10, 0x28, 0x44, 0x00, 0x41, 0x7f, 0x40,
    0x00, 0x7c, 0x04, 0x18, 0x04, 0x78, 0x7c, 0x08, 0x04, 0x04, 0x78, 0x38,
    0x44, 0x44, 0x44, 0x38, 0x7c, 0x14, 0x14, 0x14, 0x08, 0x08, 0x14, 0x14,
    0x18, 0x7c, 0x7c, 0x08, 0x04, 0x04, 0x08, 0x48, 0x54, 0x54, 0x54, 0x20,
    0x04, 0x3f, 0x44, 0x40, 0x20, 0x3c, 0x40, 0x40, 0x20, 0x7c, 0x1c, 0x20,
    0x40, 0x20, 0x1c, 0x3c, 0x40, 0x30, 0x40, 0x3c, 0x44, 0x28, 0x10, 0x28,
    0x44, 0x0c, 0x50, 0x50, 0x50, 0x3c, 0x44, 0x64, 0x54, 0x4c, 0x44, 0x00,
    0x08, 0x36, 0x41, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x41, 0x36,
    0x08, 0x00,
  ];

  const $ = cheerio.load(siteSource);
  let svgElement = $(".js-calendar-graph-svg");
  svgElement.attr("xmlns", "http://www.w3.org/2000/svg");
  svgElement.attr("height", "148");
  $(".js-calendar-graph-svg text").remove();
  svgElement.prepend("<style></style>");
  svgElement.append(
    '<a href="https://github.com/jasineri/gitartwork"><text x="24" y="132" font-size="0.6em" fill="blue">Get your own graph on jasineri/gitartwork</text></a>'
  );
  let styleElement = $(".js-calendar-graph-svg style");
  styleElement.prepend(
    "\n    :root {\n" +
      "        --c0: rgba(27, 31, 35, 0.06);\n" +
      "        --c1: #9be9a8;\n" +
      "        --c2: #40c463;\n" +
      "        --c3: #30a14e;\n" +
      "        --c4: #216e39;\n" +
      "    }\n" +
      '    .o, .o[data-level="0"] {\n' +
      "        fill: var(--c0);\n" +
      "        shape-rendering: geometricPrecision;\n" +
      "        outline: 1px solid var(--c0);\n" +
      "        outline-offset: -1px\n" +
      "    }\n" +
      '    .o[data-level="1"] {\n' +
      "        outline: 1px solid var(--c0)\n" +
      "    }\n" +
      '    .o[data-level="2"] {\n' +
      "        outline: 1px solid var(--c0)\n" +
      "    }\n" +
      '    .o[data-level="3"] {\n' +
      "        outline: 1px solid var(--c0)\n" +
      "    }\n" +
      '    .o[data-level="4"] {\n' +
      "        outline: 1px solid var(--c0)\n" +
      "    }\n" +
      "    .c {\n" +
      "        animation-iteration-count: infinite;\n" +
      "        animation-duration: 5s;\n" +
      "    }"
  );
  var htmlInputElements = $(".js-calendar-graph-svg rect");
  var classIndex = 0;
  for (let i = 0; i < text.length; i++) {
    for (let x = 0; x < 5; x++) {
      var yLine = pixels[(text.charCodeAt(i) - 32) * 5 + x];
      for (let y = 0; y < 7; y++) {
        if ((yLine >> y) & 1) {
          var htmlInputElement =
            htmlInputElements[
              Math.round((53 - text.length * 6) / 2) * 7 + i * 6 * 7 + x * 7 + y
            ];
          var dataLevel = Math.floor(Math.random() * 4) + 1;
          // htmlInputElement
          //     .setAttribute("data-level", dataLevel);
          var className = "c" + classIndex;
          $(htmlInputElement).attr("class", "o c " + className);
          styleElement.append(
            "\n@keyframes " +
              className +
              " {\n" +
              "                from {\n" +
              "transform: rotate(" +
              (Math.floor(Math.random() * 720) + 1) +
              "deg)\n" +
              "                }\n" +
              "                60% {\n" +
              "transform: rotate(0deg)\n" +
              "                }\n" +
              "                to {\n" +
              "                    fill: var(--c" +
              dataLevel +
              ")\n" +
              "                }\n" +
              "            }\n" +
              ".c." +
              className +
              " {\n" +
              "                animation-name: " +
              className +
              "\n" +
              "            }"
          );
          classIndex++;
        }
      }
    }
  }
  for (const htmlInputElement of htmlInputElements) {
    if (!$(htmlInputElement)?.attr("class")?.startsWith("o c")) {
      if (($(htmlInputElement)?.attr("data-level") || "") > "0") {
        className = "c" + classIndex;
        $(htmlInputElement).attr("class", "o c " + className);
        styleElement.append(
          "\n@keyframes " +
            className +
            " {\n" +
            "                0%, from {\n" +
            "                    fill: var(--c4);\n" +
            "                }\n" +
            "                " +
            (Math.floor(Math.random() * 90) + 1) +
            "%, to {\n" +
            "                    fill: var(--c0);\n" +
            "                }\n" +
            "            }\n" +
            ".c." +
            className +
            " {\n" +
            "                animation-name: " +
            className +
            "\n" +
            "            }"
        );
        classIndex++;
      } else {
        $(htmlInputElement).attr("class", "o");
      }
    }
  }
  fs.writeFileSync(svgFileName, cheerio.html(svgElement));
};
